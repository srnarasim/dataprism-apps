name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install root dependencies
      run: npm ci
      
    - name: Install demo-analytics dependencies
      run: cd apps/demo-analytics && npm ci
      
    - name: Install docs dependencies
      run: cd apps/docs && npm ci
      
    - name: Install ironcalc-spreadsheet dependencies
      run: cd apps/ironcalc-spreadsheet && npm ci
      
    - name: Build demo-analytics
      run: cd apps/demo-analytics && npm run build
      
    - name: Build docs
      run: cd apps/docs && npm run build
      
    - name: Build ironcalc-spreadsheet
      run: cd apps/ironcalc-spreadsheet && NODE_ENV=production npm run build
      
    - name: Create combined dist directory
      run: |
        mkdir -p dist
        # Copy demo analytics to demo-analytics subdirectory
        mkdir -p dist/demo-analytics
        cp -r apps/demo-analytics/dist/* dist/demo-analytics/
        # Copy docs content to guide, api, and other doc subdirectories
        # Copy everything from docs except index.html to preserve our custom landing page
        mkdir -p dist/guide dist/api dist/examples dist/plugins
        if [ -d "apps/docs/.vitepress/dist/guide" ]; then cp -r apps/docs/.vitepress/dist/guide/* dist/guide/; fi
        if [ -d "apps/docs/.vitepress/dist/api" ]; then cp -r apps/docs/.vitepress/dist/api/* dist/api/; fi  
        if [ -d "apps/docs/.vitepress/dist/examples" ]; then cp -r apps/docs/.vitepress/dist/examples/* dist/examples/; fi
        if [ -d "apps/docs/.vitepress/dist/plugins" ]; then cp -r apps/docs/.vitepress/dist/plugins/* dist/plugins/; fi
        # Copy other docs assets but preserve our custom index.html
        find apps/docs/.vitepress/dist -name "*.css" -o -name "*.js" -o -name "*.woff*" -o -name "*.ico" | while read file; do
          rel_path=${file#apps/docs/.vitepress/dist/}
          mkdir -p dist/$(dirname "$rel_path")
          cp "$file" dist/"$rel_path"
        done
        # Copy ironcalc spreadsheet to ironcalc-spreadsheet subdirectory
        mkdir -p dist/ironcalc-spreadsheet
        cp -r apps/ironcalc-spreadsheet/dist/* dist/ironcalc-spreadsheet/
        
    - name: Create index page with app links
      run: |
        cat > dist/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>DataPrism Apps</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; background: #f8fafc; }
                .header { text-align: center; margin-bottom: 3rem; }
                .logo { font-size: 2.5rem; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
                .tagline { color: #64748b; font-size: 1.1rem; margin-top: 0.5rem; }
                .app-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin: 2rem 0; }
                .app-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); transition: transform 0.2s, box-shadow 0.2s; }
                .app-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
                .app-card h3 { margin-top: 0; color: #1e293b; font-size: 1.3rem; }
                .app-card p { color: #64748b; line-height: 1.6; }
                .btn { display: inline-block; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; margin-top: 1rem; font-weight: 500; transition: transform 0.2s; }
                .btn:hover { transform: translateY(-1px); }
                .status { display: inline-block; padding: 0.25rem 0.5rem; background: #10b981; color: white; font-size: 0.75rem; border-radius: 4px; margin-left: 0.5rem; }
                footer { margin-top: 4rem; padding-top: 2rem; border-top: 1px solid #e2e8f0; text-align: center; color: #64748b; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1 class="logo">DataPrism</h1>
                <p class="tagline">Browser-native analytics with WebAssembly</p>
            </div>
            
            <div class="app-grid">
                <div class="app-card">
                    <h3>Demo Analytics <span class="status">Live</span></h3>
                    <p>Interactive data analytics demo showcasing DataPrism's core capabilities with DuckDB, WebAssembly, and visualization plugins.</p>
                    <a href="./demo-analytics/" class="btn">Launch Demo</a>
                </div>
                
                <div class="app-card">
                    <h3>IronCalc Spreadsheet <span class="status">New</span></h3>
                    <p>Excel-compatible spreadsheet application powered by IronCalc formula engine with 180+ functions and real-time calculation.</p>
                    <a href="./ironcalc-spreadsheet/" class="btn">Launch Spreadsheet</a>
                </div>
                
                <div class="app-card">
                    <h3>Documentation</h3>
                    <p>Complete documentation for DataPrism Core, plugins, and integration guides.</p>
                    <a href="./guide/" class="btn">View Docs</a>
                </div>
            </div>
            
            <footer>
                <p>DataPrism - Experience the future of browser-based data analytics</p>
                <p><small>Built with ❤️ using WebAssembly, React, and DuckDB</small></p>
            </footer>
        </body>
        </html>
        EOF
        
    - name: Setup Pages
      uses: actions/configure-pages@v5
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4